# Инструкция по настройке бота

## Шаг 1: Получение токена бота

1. Откройте Telegram и найдите [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Придумайте имя для бота (например, "Недели жизни")
4. Придумайте username для бота (должен заканчиваться на `bot`, например, `MyLifeWeeks_bot`)
5. Скопируйте полученный токен

## Шаг 2: Создание файла конфигурации

1. В папке с ботом создайте файл `.env`
2. Добавьте в него строку:
```
TELEGRAM_BOT_TOKEN=ваш_токен_от_BotFather
```
3. Сохраните файл

## Шаг 3: Настройка канала для обязательной подписки

По умолчанию бот требует подписки на канал `@savinih_vitaliy`.

Если вы хотите изменить канал или отключить проверку:

1. Откройте файл `bot.py`
2. Найдите строку:
```python
REQUIRED_CHANNEL = "@savinih_vitaliy"
```
3. Измените на ваш канал (например, `@your_channel`)
4. Или закомментируйте проверку подписки в функциях `start` и `handle_birthdate`

**Важно:** Бот должен быть администратором канала для проверки подписки!

Как добавить бота в администраторы канала:
1. Откройте ваш канал
2. Настройки → Администраторы → Добавить администратора
3. Найдите вашего бота и добавьте его
4. Дайте права на "Просмотр списка подписчиков"

## Шаг 4: Запуск бота

### Windows:
- Просто запустите файл `start_bot.bat`
- Он автоматически установит все зависимости и запустит бота

### Linux/Mac:
```bash
pip install -r requirements.txt
python bot.py
```

## Настройка времени отправки уведомлений

По умолчанию бот проверяет пользователей каждый день в **10:00** и отправляет обновления тем, у кого началась новая неделя.

Чтобы изменить время, откройте файл `bot.py` и найдите строку:

```python
scheduler.add_job(
    check_weekly_updates,
    trigger=CronTrigger(hour=10, minute=0),  # Измените час и минуты здесь
    ...
)
```

Примеры:
- `hour=9, minute=30` - отправка в 9:30
- `hour=20, minute=0` - отправка в 20:00
- `hour=12, minute=15` - отправка в 12:15

## Тестирование бота

1. Запустите бота
2. Напишите ему в Telegram команду `/start`
3. Отправьте свою дату рождения
4. Получите таблицу недель жизни

Чтобы проверить автоматическую отправку вручную:
- Отправьте команду `/check_now`

## База данных

Бот автоматически создаст файл `lifeweeks.db` для хранения данных пользователей.

Данные, которые хранятся:
- ID пользователя Telegram
- Username и имя
- Дата рождения
- Номер последней отправленной недели
- Даты создания и обновления

## Как работает автоматическая отправка

1. Пользователь отправляет свою дату рождения
2. Бот сохраняет её в базу данных
3. Каждый день в указанное время бот:
   - Проверяет всех пользователей в базе
   - Вычисляет текущую неделю жизни каждого
   - Если текущая неделя больше последней отправленной:
     * Отправляет поздравление
     * Отправляет обновленную таблицу
     * Обновляет номер последней отправленной недели

Таким образом, пользователь получает сообщение только один раз при переходе на новую неделю.

## Запуск бота как службы (Windows)

Чтобы бот работал постоянно в фоне:

1. Установите [NSSM](https://nssm.cc/download)
2. Откройте командную строку от администратора
3. Выполните:
```
nssm install LifeWeeksBot "C:\путь\к\python.exe" "C:\путь\к\bot.py"
nssm set LifeWeeksBot AppDirectory "C:\путь\к\папке\с\ботом"
nssm start LifeWeeksBot
```

## Запуск бота как службы (Linux)

Создайте systemd unit файл `/etc/systemd/system/lifeweeks-bot.service`:

```ini
[Unit]
Description=Life Weeks Telegram Bot
After=network.target

[Service]
Type=simple
User=ваш_пользователь
WorkingDirectory=/путь/к/боту
ExecStart=/usr/bin/python3 /путь/к/боту/bot.py
Restart=always

[Install]
WantedBy=multi-user.target
```

Затем:
```bash
sudo systemctl daemon-reload
sudo systemctl enable lifeweeks-bot
sudo systemctl start lifeweeks-bot
```

## Логи

Бот выводит логи в консоль. Для отслеживания работы смотрите на сообщения:
- `Бот запущен!` - бот успешно запустился
- `Scheduler запущен` - планировщик активирован
- `Запуск проверки еженедельных обновлений...` - началась проверка
- `Найдено N пользователей для обновления` - количество пользователей для отправки
- `Отправлено еженедельное обновление пользователю X` - успешная отправка

## Возможные проблемы

### Ошибка "TELEGRAM_BOT_TOKEN не найден"
- Убедитесь, что создали файл `.env`
- Проверьте, что токен указан правильно без пробелов

### Шрифты не загружаются (изображения с плохим текстом)
- На Windows: обычно работает автоматически
- На Linux: установите `sudo apt-get install fonts-dejavu`

### База данных не создается
- Проверьте права на запись в папке с ботом
- Убедитесь, что SQLite установлен (обычно идет с Python)

### Уведомления не приходят
- Проверьте, что бот запущен и не остановлен
- Проверьте логи на наличие ошибок
- Используйте `/check_now` для тестирования

### Ошибка при проверке подписки
- Убедитесь, что бот добавлен в администраторы канала
- Проверьте правильность username канала (должен начинаться с @)
- Проверьте, что канал публичный или бот имеет доступ
- Если используете приватный канал, используйте ID канала вместо username (формат: `-100xxxxxxxxxx`)

## Как работает проверка подписки

1. **При запуске `/start`:**
   - Бот проверяет подписку пользователя
   - Если не подписан → показывает кнопки для подписки
   - Если подписан → показывает приветственное сообщение

2. **При отправке даты рождения:**
   - Бот снова проверяет подписку (на случай отписки)
   - Если не подписан → просит подписаться
   - Если подписан → генерирует и отправляет таблицу

3. **Кнопка "Проверить подписку":**
   - Повторно проверяет статус подписки
   - Обновляет сообщение в зависимости от результата

4. **Еженедельные уведомления:**
   - Отправляются всем пользователям в базе
   - Проверка подписки НЕ выполняется (уведомления приходят даже после отписки)
   - Если нужно отключить уведомления → просто заблокируйте бота

## Получение ID приватного канала

Если ваш канал приватный:

1. Перешлите любое сообщение из канала боту [@userinfobot](https://t.me/userinfobot)
2. Он покажет ID канала в формате `-100xxxxxxxxxx`
3. Используйте этот ID в `REQUIRED_CHANNEL`:
```python
REQUIRED_CHANNEL = "-100123456789"  # ваш ID канала
```

